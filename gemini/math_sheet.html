<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¦ç”Ÿå£ç®—ç”Ÿæˆå™¨ - ä¿®å¤ç‰ˆ</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f5f7fa;
        }

        body {
            font-family: "KaiTi", "æ¥·ä½“", "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: #333;
            -webkit-print-color-adjust: exact;
        }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .control-panel {
            background: white;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 15px auto;
            max-width: 950px;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid #eee;
            padding: 5px 10px;
            border-radius: 5px;
            background: #fafafa;
        }
        
        .control-group label { font-weight: bold; color: #555; }
        
        h1.screen-title {
            text-align: center;
            color: #333;
            font-size: 22px;
            margin: 15px 0 5px;
        }

        input[type="number"] {
            width: 55px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-weight: bold;
            color: var(--primary-color);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
        }
        button.print-btn { background-color: #2ecc71; }
        button:hover { opacity: 0.9; }

        /* --- è¯•å·åŒºåŸŸ --- */
        .paper-container {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto 30px;
            padding: 15mm 12mm; /* A4 æ‰“å°ä¼˜åŒ–å†…è¾¹è· */
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        .paper-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #999;
            padding-bottom: 5px;
        }

        .paper-header h2 {
            font-size: 22px;
            margin: 0;
            letter-spacing: 2px;
        }

        .paper-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 14px;
            font-family: "SimSun", "å®‹ä½“", serif;
        }

        #question-list {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* å¼ºåˆ¶ä¸‰åˆ— */
            gap: 12px 20px; 
        }

        .question-item {
            font-size: 16px; /* å­—ä½“å¤§å°é€‚é…é•¿ç®—å¼ */
            line-height: 1.6;
            display: flex;
            align-items: flex-end;
            break-inside: avoid;
        }

        .formula {
            white-space: nowrap;
            font-family: Arial, sans-serif;
            margin-right: 5px;
        }

        .answer-space {
            flex-grow: 1;
            border-bottom: 1px solid #000;
            min-width: 30px;
        }

        /* --- æ‰“å°é€‚é… --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; }
            .control-panel, .screen-title { display: none !important; }
            .paper-container { width: 100%; margin: 0; box-shadow: none; padding: 10mm 12mm; }
            #question-list { grid-template-columns: 1fr 1fr 1fr; gap: 10px 15px; }
        }
    </style>
</head>
<body>

    <h1 class="screen-title">å°å­¦ç”Ÿå£ç®—ç”Ÿæˆå™¨ (æ— Bugç‰ˆ)</h1>

    <div class="control-panel">
        <div class="control-group">
            <label>é¢˜ç›®æ€»æ•°:</label>
            <input type="number" id="totalCount" value="50" min="10" max="100">
        </div>

        <div class="control-group">
            <label>æœ€å¤§æ•°å­—ä¸Šé™:</label>
            <input type="number" id="maxNum" value="20" min="5" max="1000">
        </div>

        <div class="control-group" style="border-color: #4a90e2; background: #eaf4ff;">
            <label>å‚ä¸è¿ç®—æ•°å­—ä¸ªæ•°:</label>
            <input type="number" id="termCount" value="3" min="2" max="5" title="é€‰3è¡¨ç¤º: A+B+C=">
        </div>

        <div class="control-group">
            <label><input type="checkbox" id="useAdd" checked> åŠ </label>
            <label><input type="checkbox" id="useSub" checked> å‡</label>
            <label><input type="checkbox" id="useMul" checked> ä¹˜</label>
            <label><input type="checkbox" id="useDiv" checked> é™¤</label>
        </div>

        <button onclick="generateQuestions()">ç”Ÿæˆè¯•å·</button>
        <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°</button>
    </div>

    <div class="paper-container">
        <div class="paper-header">
            <h2>å°å­¦ç”Ÿæ•°å­¦å£ç®—ç»ƒä¹ </h2>
        </div>
        <div class="paper-info">
            <span>å§“åï¼š__________</span>
            <span>æ—¥æœŸï¼š__________</span>
            <span>ç”¨æ—¶ï¼š__________</span>
            <span>å¾—åˆ†ï¼š__________</span>
        </div>
        <div id="question-list"></div>
    </div>

    <script>
        // è·å–éšæœºæ•´æ•° [min, max]
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // æ ¸å¿ƒç”Ÿæˆå‡½æ•°ï¼šä¿®å¤äº†Infinity Bug
        function generateSingleQuestion(maxNum, termCount, allowedOps) {
            let maxRetries = 20; // å¢åŠ é‡è¯•æ¬¡æ•°
            
            while (maxRetries > 0) {
                maxRetries--;
                
                try {
                    // 1. åˆå§‹åŒ–ç¬¬ä¸€ä¸ªæ•°å­—
                    let currentVal = getRandomInt(1, maxNum);
                    let formulaStr = `${currentVal}`;

                    // 2. å¾ªç¯ç”Ÿæˆåç»­æ­¥éª¤
                    for (let i = 0; i < termCount - 1; i++) {
                        // åˆ¤æ–­æ˜¯å¦æ˜¯æœ€åä¸€æ­¥
                        let isLastStep = (i === termCount - 2);
                        
                        // éšæœºé€‰è¿ç®—ç¬¦
                        let op = allowedOps[Math.floor(Math.random() * allowedOps.length)];
                        let nextVal;

                        if (op === 'add') {
                            // åŠ æ³•ï¼šç¡®ä¿å’Œ <= maxNum
                            let limit = maxNum - currentVal;
                            if (limit < 1) throw "Add limit reached"; 
                            
                            nextVal = getRandomInt(1, limit);
                            currentVal += nextVal;
                            formulaStr += ` + ${nextVal}`;

                        } else if (op === 'sub') {
                            // å‡æ³•é€»è¾‘å…³é”®ä¿®æ”¹ï¼š
                            // å¦‚æœä¸æ˜¯æœ€åä¸€æ­¥ï¼Œç»“æœå¿…é¡» >= 1 (ç¦æ­¢ä¸­é—´ç»“æœä¸º0ï¼Œé˜²æ­¢åç»­ä¹˜é™¤å‡ºé”™)
                            // å¦‚æœæ˜¯æœ€åä¸€æ­¥ï¼Œç»“æœå¯ä»¥ >= 0
                            let minResult = isLastStep ? 0 : 1;
                            
                            // currentVal - nextVal >= minResult  =>  nextVal <= currentVal - minResult
                            let limit = currentVal - minResult;
                            
                            if (limit < 1) throw "Sub limit reached (too small)";
                            
                            nextVal = getRandomInt(1, limit);
                            currentVal -= nextVal;
                            formulaStr += ` - ${nextVal}`;

                        } else if (op === 'mul') {
                            // ä¹˜æ³•ï¼šç¡®ä¿ç§¯ <= maxNum
                            // å…³é”®ä¿®å¤ï¼šå¦‚æœ currentVal æ˜¯ 0ï¼ŒmaxNum/0 ä¼šå˜æˆ Infinity
                            if (currentVal === 0) {
                                // å¦‚æœå½“å‰æ˜¯0ï¼Œåé¢ä¹˜ä»»ä½•æ•°éƒ½æ˜¯0ã€‚ä¸ºäº†é¿å…æ— èŠé¢˜ï¼Œç›´æ¥è·³è¿‡æˆ–é‡è¯•
                                throw "Zero multiplication"; 
                            }

                            let limit = Math.floor(maxNum / currentVal);
                            if (limit < 2) throw "Mul limit reached"; // åªèƒ½ä¹˜1æˆ–0æ²¡æ„ä¹‰
                            
                            nextVal = getRandomInt(2, limit);
                            currentVal *= nextVal;
                            formulaStr += ` Ã— ${nextVal}`;

                        } else if (op === 'div') {
                            // é™¤æ³•ï¼šå¿…é¡»æ•´é™¤
                            // å…³é”®ä¿®å¤ï¼šå¦‚æœ currentVal < 2ï¼Œæ²¡æ³•é™¤
                            if (currentVal < 2) throw "Div limit reached (too small)";

                            // å¯»æ‰¾å› å­
                            let factors = [];
                            for(let k=2; k<=currentVal; k++) {
                                if(currentVal % k === 0) factors.push(k);
                            }
                            
                            if (factors.length === 0) throw "No factors";
                            
                            nextVal = factors[getRandomInt(0, factors.length - 1)];
                            currentVal /= nextVal;
                            formulaStr += ` Ã· ${nextVal}`;
                        }
                    }

                    // æœ€ç»ˆæ ¡éªŒ
                    if (currentVal < 0 || currentVal > maxNum) throw "Result out of bounds";
                    if (formulaStr.includes("Infinity")) throw "Infinity Detected"; // æœ€ç»ˆä¿é™©

                    return `${formulaStr} =`;

                } catch (e) {
                    // console.log("Retry reason:", e);
                    continue; 
                }
            }
            // å¦‚æœé‡è¯•å¤šæ¬¡éƒ½å¤±è´¥ï¼ˆæç½•è§ï¼‰ï¼Œè¿”å›ä¿åº•é¢˜ç›®
            return `1 + 1 =`;
        }

        function generateQuestions() {
            const total = parseInt(document.getElementById('totalCount').value) || 50;
            const maxNum = parseInt(document.getElementById('maxNum').value) || 20;
            const termCount = parseInt(document.getElementById('termCount').value) || 2;
            
            const useAdd = document.getElementById('useAdd').checked;
            const useSub = document.getElementById('useSub').checked;
            const useMul = document.getElementById('useMul').checked;
            const useDiv = document.getElementById('useDiv').checked;

            let ops = [];
            if (useAdd) ops.push('add');
            if (useSub) ops.push('sub');
            if (useMul) ops.push('mul');
            if (useDiv) ops.push('div');

            if (ops.length === 0) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¿ç®—ç±»å‹ï¼");
                return;
            }

            const container = document.getElementById('question-list');
            container.innerHTML = '';

            for (let i = 0; i < total; i++) {
                let q = generateSingleQuestion(maxNum, termCount, ops);
                
                const div = document.createElement('div');
                div.className = 'question-item';
                div.innerHTML = `<span class="formula">${q}</span><span class="answer-space"></span>`;
                container.appendChild(div);
            }
        }

        window.onload = generateQuestions;
    </script>
</body>
</html>
